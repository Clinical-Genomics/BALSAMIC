# vim: syntax=python tabstop=4 expandtab
# coding: utf-8

import os
from BALSAMIC.utils.rule import get_chrom
from BALSAMIC.utils.rule import get_result_dir
from BALSAMIC.utils.rule import get_vcf
from BALSAMIC import __version__ as bv

shell.prefix("set -eo pipefail; ")

rule_dir = config["rule_directory"]
benchmark_dir = config["analysis"]["benchmark"]
fastq_dir = get_result_dir(config) + "/fastq/"
bam_dir = get_result_dir(config) + "/bam/"
cnv_dir = get_result_dir(config) + "/cnv/"
cutadapt_dir = get_result_dir(config) + "/cutadapt/"
fastqc_dir = get_result_dir(config) + "/fastqc/"
result_dir = get_result_dir(config) + "/"
vcf_dir = get_result_dir(config) + "/vcf/"
vep_dir = get_result_dir(config) + "/vep/"

singularity_image = config['singularity']['image'] 


try:
    SENTIEON_LICENSE = os.environ["SENTIEON_LICENSE"]
    SENTIEON_INSTALL_DIR = os.environ["SENTIEON_INSTALL_DIR"]
    SENTIEON_DNASCOPE = os.environ["SENTIEON_DNASCOPE"]
    SENTIEON_TNSCOPE = os.environ["SENTIEON_TNSCOPE"]
except Exception as error:
    print("ERROR: Set Environment variable to run this pipeline.")
    raise


# Define set of rules
qc_rules = [
  "snakemake_rules/quality_control/fastp.rule",
  "snakemake_rules/quality_control/fastqc.rule",
  "snakemake_rules/quality_control/GATK.rule",
  "snakemake_rules/quality_control/multiqc.rule",
  "snakemake_rules/quality_control/picard.rule",
  "snakemake_rules/quality_control/sambamba_depth.rule"
  ]


align_rules = [
  "snakemake_rules/align/bwa_mem.rule",
  "snakemake_rules/align/samtools.rule"
  ]

annotation_rules = [
  "snakemake_rules/annotation/vep.rule"
  ]

variantcalling_rules = [
  "snakemake_rules/variant_calling/germline.rule",
  "snakemake_rules/variant_calling/split_bed.rule"
  ]

germline_caller = ["haplotypecaller", "strelka_germline", "manta_germline", "dnascope"]

if config['analysis']['analysis_type'] == "paired":

    qc_rules.append("snakemake_rules/quality_control/contest.rule")

    variantcalling_rules.extend([
      "snakemake_rules/variant_calling/somatic_tumor_normal.rule",
      "snakemake_rules/variant_calling/somatic_sv_tumor_normal.rule",
      "snakemake_rules/variant_calling/mergetype.rule",
      "snakemake_rules/variant_calling/cnvkit_paired.rule"
      ])

    somatic_caller_snv = ["mutect", "vardict", "strelka"]
    sentieon_callers = []
    somatic_caller_sv = ["manta"]
    vcf_merge = ["vcfmerge"]
    
    cnvkit_output = cnv_dir + "cnvkit_paired.done"

else:

    variantcalling_rules.extend([
      "snakemake_rules/variant_calling/cnvkit_single.rule",
      "snakemake_rules/variant_calling/mergetype_tumor.rule",
      "snakemake_rules/variant_calling/somatic_tumor_only.rule",
      "snakemake_rules/variant_calling/somatic_sv_tumor_only.rule"
      ])

    somatic_caller_snv = ["mutect", "vardict"]
    sentieon_callers = ["tnhaplotyper"]
    somatic_caller_sv = ["manta"]
    vcf_merge = ["vcfmerge"]
      
    cnvkit_output = cnv_dir + "cnvkit_single.done"

somatic_caller = somatic_caller_snv + somatic_caller_sv + vcf_merge + sentieon_callers

config["rules"] = align_rules + qc_rules + variantcalling_rules + annotation_rules

for r in config["rules"]:
    include: os.path.join(rule_dir + r)

var_class = ["somatic", "germline"]
var_type = ["SNV", "SV"]

rule all:
    input:
        os.path.join(*([result_dir + "qc/" + "multiqc_report.html"])),
        expand(vep_dir + "{vcf}.vcf.gz", vcf=get_vcf(config, somatic_caller, [config["analysis"]["case_id"]])),
        expand(vep_dir + "{vcf}.vcf.gz", vcf=get_vcf(config, germline_caller, config["samples"])),
        cnvkit_output
    output:
        os.path.join(get_result_dir(config), "analysis_finish")
    shell:
        "date +'%Y-%M-%d T%T %:z' > {output}"
