#!python
# vim: syntax=python tabstop=4 expandtab
# coding: utf-8

import os

from yapf.yapflib.yapf_api import FormatFile
from snakemake.logging import logger
from BALSAMIC.utils.cli import write_json
from BALSAMIC.utils.rule import get_rule_output 
from BALSAMIC.utils.rule import get_result_dir
from BALSAMIC import __version__ as bv


shell.prefix("set -eo pipefail; ")

result_dir = get_result_dir(config) + "/"
fastq_dir = result_dir + "fastq/"
bam_dir = result_dir +" bam/"
cnv_dir = result_dir + "cnv/"
cutadapt_dir = result_dir + "cutadapt/"
fastqc_dir = result_dir + "fastqc/"
vcf_dir = result_dir + "vcf/"
vep_dir = result_dir + "vep/"
qc_dir = result_dir + "qc/"
benchmark_dir = config["analysis"]["benchmark"]
singularity_image = config['singularity']['image']

# explictly check if cluster_config dict has zero keys.
if len(cluster_config.keys()) == 0:
    cluster_config = config

rules = [
  "snakemake_rules/align/bwa_mem.rule",
  "snakemake_rules/quality_control/fastp.rule",
  "snakemake_rules/quality_control/fastqc.rule",
  "snakemake_rules/quality_control/picard.rule",
  "snakemake_rules/quality_control/sambamba_depth.rule",
  "snakemake_rules/quality_control/mosdepth.rule",
  "snakemake_rules/quality_control/multiqc.rule",
  "snakemake_rules/quality_control/GATK.rule",
]

for rule in rules:
  include: rule

  
if 'delivery' in config:
    wildcard_dict = { "sample": list(config["samples"].keys()),
                      "case_name": config["analysis"]["case_id"],
                      "allow_missing": True
                    }

    if 'rules_to_deliver' in config:
        rules_to_deliver = config['rules_to_deliver'].split(",")
    else:
        rules_to_deliver = ['multiqc']

    output_files_ready = [('path', 'path_index', 'step', 'tag', 'id', 'format')]
    
    for my_rule in set(rules_to_deliver):
        try:
            housekeeper_id = getattr(rules, my_rule).params.housekeeper_id
        except (ValueError, AttributeError, RuleException, WorkflowError) as e:
            LOG.warning("Cannot deliver step (rule) {}: {}".format(my_rule,e))
            continue

        LOG.info("Delivering step (rule) {}.".format(my_rule))
        output_files_ready.extend(get_rule_output(rules=rules, rule_name=my_rule, output_file_wildcards=wildcard_dict))

    output_files_ready = [dict(zip(output_files_ready[0], value)) for value in output_files_ready[1:]]
    delivery_ready = os.path.join(get_result_dir(config), "delivery_report", config["analysis"]["case_id"] + "_delivery_ready.hk" )
    write_json(output_files_ready, delivery_ready)
    FormatFile(delivery_ready) 
 

rule all:
  input:
    os.path.join(*([result_dir + "qc/" + "multiqc_report.html"])),
  output:
    os.path.join(get_result_dir(config), "analysis_finish")
  shell:
    "date +'%Y-%m-%d T%T %:z' > {output}"

